//> YAJET -- Yet Another JavaScript Emplate Tengine
//> Author: Mihai Bazon <mihai.bazon@gmail.com>
//> Distributed under the BSD license.  Visit www.yajet.net for details.
//> (c) Mihai Bazon 2010
function YAJET(e){function r(){return"__GSY"+ ++n}function i(e){return e[e.length-1]}function s(e,t,n){var r=0,i=e.length,s=new Array(i);while(--i>=0)s[r]=t.call(n,e[r++]);return s}function d(e){return e=w(e),"function "+e+"(){"+"return YAJET.process("+m(e)+", this, arguments)}"}function v(n){function L(){return n.charAt(l)}function A(){return n.charAt(l++)}function O(e){return n.substr(l,e!=null?e:v)}function M(e){a.push(e)}function _(){y.length>0&&M("OUT("+m(y)+");"),y=""}function D(e){var t=!1;while(B(" ")||B("	")||B("\n")||B("Â ")||!e&&(B("//","\n")||B("/*","*/")||B("<!--","-->")))t=!0;return t}function P(e){var t=j(e);return t||g("Expecting "+e+" at "+l),t}function H(e){D(),l+=P(e).length}function B(e,t){var r=j(e);if(r){l+=r.length;if(t){var i=n.indexOf(t,l);i==-1&&g('Unterminated "'+e+'" at '+O()),l=i+t.length}}return r}function j(e){return e instanceof RegExp?(e=e.exec(O()))&&{match:e[0],length:e[0].length,groups:e}:O(e.length)==e?{match:e,length:e.length}:null}function F(e,t){t||(t="}"),M(e),f.push(t)}function I(){var e=f.pop();e instanceof Function?e():M(e)}function q(e){var t=a;return a=e,t}function R(e){D();var t=L(),n=o[t];if(n){var r=[n],s="",u=[];++l;while(l<v){var a=L();if(a==i(r)){r.pop(),++l;if(r.length==0)return e?(s=w(s),s&&u.push(s),u):s;s+=a}else a in o?(r.push(o[a]),++l,s+=a):a=='"'||a=="'"?s+=m(z()):e&&r.length==1&&(B(",")||B(";")||B("=>")||B(".."))?(u.push(s),D(),s=""):D()?s+=" ":(++l,s+=a)}}}function U(){while(l<v){var e=n.indexOf(u,l);if(e<0){y+=O();break}e>l&&(y+=O(e-l)),l=e+1;if(B(u))y+=u;else if(B("#")){if(0==(l=n.indexOf("\n",l)+1))break}else _(),V()}l=v,_()}function z(){var e=L();if(e=="'"||e=='"'){var t=l,r=!1,i="";do{++l;var s=L();if(!r){if(s=="\\"){r=!0;continue}if(s==e)return++l,i}else switch(s){case"b":s="\b";break;case"f":s="\f";break;case"n":s="\n";break;case"t":s="	";break;case"r":s="\r";break;case"x":++l,s=parseInt(O(2),16),isNaN(s)&&g("Expecting an Unicode character code at: "+l),s=String.fromCharCode(s),l+=2;break;case"u":++l,s=parseInt(O(4),16),isNaN(s)&&g("Expecting an Unicode character code at: "+l),s=String.fromCharCode(s),l+=4}r=!1,i+=s}while(l<v);g("Unterminated string at: "+n.substr(t))}}function W(e){var t="",n=0,r,i;for(;;){r=L(),i=r.charCodeAt(0);if(!(i>=65&&i<=90||i>=97&&i<=122||i>=48&&i<=57||i==95||i==36&&!e||i==124||i==46))break;t+=r,i==36||i==124||i==46?++n:n=0,++l}return n>0&&(l-=n,t=t.substr(0,t.length-n)),t}function X(){var e=[];H("(");while(l<v){D();if(j("("))e.push(R(!0));else{if(B(")"))break;e.push(W())}}M("var "+s(e,function(e){return e instanceof Array?e[0]+" = "+e[1]:e}).join(", ")+";")}function V(){if(B("_"))M("VUT($_);");else if(B("-"))D(!0);else if(B("(")){var t=W();if(t){t=t.toLowerCase();var n=e.directives[t]||x[t];n||g("Unknown directive: "+t.toUpperCase()),n.call(E,T)}else--l,M(R()+";")}else if(B(")"))I();else if(B("("))g("Unrecognized construct at "+O());else if(j("{")){var r=R(!0);if(r.length>0&&/\S/.test(r[0])){var i=r.shift();while(r.length>0){var s=w(r.shift()),o=s.indexOf("("),u=null;o>=0&&(u=w(s.substring(o+1,s.length-1)),s=s.substring(0,o)),u?u=i+", "+u:u=i,i="YAJET.filter("+m(s)+", "+u+")"}M("VUT("+i+");")}}else{D();var r=W(!0).split("|"),i=r.shift();while(r.length>0)i="YAJET.filter("+m(r.shift())+", "+i+")";M("VUT("+i+");")}}var a=[],f=[],l=0,v=n.length,y="",E=this,S=[],x={"if":function(){F("if ("+R()+") {")},aif:function(){var e=R(!0),t=e.length>1?e[1]:"it",n=e.length>2?e[2]:t+" != null && "+t+" !== false && "+"!("+t+" instanceof Array && "+t+".length == 0) && "+"!("+t+" === '')";F("(function("+t+") { if ("+n+") {","}}).call(this, "+e[0]+");")},unless:function(){F("if (!("+R()+")) {")},"else":function(){M("} else {"),H(")")},elsif:function(){M("} else if ("+R()+") {"),H(")")},maphash:function(){var e=R(!0),t=e[0],n=e[1],i=e[2],s=r();F("(function("+s+") {"+"for (var "+t+" in "+s+") {"+"if ("+s+".hasOwnProperty("+t+")) try {"+"var "+n+" = "+s+"["+t+"];",p+"}}).call(this, "+i+");")},map:function(){var e=R(!0),t,n,i,s=r(),o=r();e.length==3?(t=e[0],n=e[1],i=e[2]):(t=r(),e.length==2?(n=e[0],i=e[1]):e.length==1&&(i=e[0])),F("(function("+s+") {"+"for (var "+(e.length==1?"$_,":"")+o+" = "+s+".length,"+t+" = 0; "+t+" < "+o+"; ++"+t+") try {"+(e.length==1?"with ($_ = "+s+"["+t+"]) {":"var "+n+" = "+s+"["+t+"];"),(e.length==1?"}":"")+p+"}).call(this, "+i+");")},repeat:function(){var e=R(!0),t,n=1,i,s=r();e.length==3&&(n=e.shift()),t=e.shift(),i=e.shift()||r(),F("(function("+s+") {"+"for (var "+i+" = "+n+"; "+i+" <= "+s+"; ++"+i+") try {",p+"}).call(this, "+t+");")},"continue":function(){M("throw YAJET.X_CONT;"),H(")")},"break":function(){M("throw YAJET.X_BREK;"),H(")")},let:function(){F("(function(){","}).call(this);"),X()},"var":function(){X(),H(")")},"with":function(){F("with ("+R()+") {")},block:function(){D();var e=W(),t=w(R());F("function "+e+"("+t+") {"+c,h+"}")},"export":function(){D();var e=W(),t=w(R());F(e+" = __EXPORTS["+m(e)+"] = function("+t+") {"+c,h+"}; "),S.push(e)},"import":function(){var e=R(!0);H(")"),M(s(e,d).join(";\n")+";")},process:function(){D();var e=W(),t=R();H(")"),M("VUT(YAJET.process("+m(e)+", this, ["+t+"]));")},wrap:function(){D();var e=W(),t=w(R());t&&(t+=", "),e="(typeof "+e+" == 'function' ? "+e+" : YAJET.TEMPLATES."+e+")",F("VUT("+e+".call(this, "+t+"function(OUT, VUT){","}));")},content:function(){M("if (arguments[arguments.length - 1] instanceof Function) arguments[arguments.length - 1].call(this, OUT, VUT);"),H(")")},literal:function(){var e,t,r;D(),e=z()+")",B(/^[ \t\xA0]*\n/),t=n.indexOf(e,l),t<0&&g("Unfinished LITERAL (was looking for "+e),r=n.substring(l,t),l=t+e.length,M("OUT("+m(r)+")")},syntax:function(){var e=u;D(),u=A(),F("",function(){u=e})}};x.when=x["if"],x.awhen=x.aif,x.foreach=x.map;var T={peek:L,next:A,rest:O,out:M,skip_ws:D,assert:P,assert_skip:H,skip:B,looking_at:j,block_open:F,block_close:I,read_balanced:R,read_string:z,read_simple_token:W,read_valist:X,to_js_string:m,trim:w,map:s,set_output:q,directives:e.directives,EX_PARSE:g};U(),e.with_scope&&(a.unshift("with (this) {"),a.push("}")),S.length>0&&a.unshift("var "+S.join(", ")+";");var N=b.call(this,a.join("\n"));if(S.length>0){var C=N(this.X_IMPORT);for(var k in C)C.hasOwnProperty(k)&&(t[k]=C[k])}return N}function m(e){return'"'+e.replace(/\x5c/g,"\\\\").replace(/\r?\n/g,"\\n").replace(/\t/g,"\\t").replace(/\x22/g,'\\"')+'"'}function g(e){throw new Error(e)}function y(e){throw new Error(e)}function b(e){try{e=f+c+e+l;var t=this,n=new Function("YAJET",e);function r(e){return n.call(e,t)}return r.orig=n,r.code=e,r}catch(i){throw window.console&&console.log("%s",e),i.yajetCode=e,i}}function w(e){return e.replace(/^\s+|\s+$/g,"")}function S(e,t,n,r){r={};for(n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);for(n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}function x(e,t){t==null&&(t=0);var n,r,i;try{n=Array.prototype.slice.call(e,t)}catch(s){n=new Array(e.length-t);for(r=t,i=0;r<e.length;++r,++i)n[i]=e[r]}return n}e=S(e||{},{reader_char:"$",filters:{},directives:{},with_scope:!1});var t=this.TEMPLATES={},n=0,o={"(":")","{":"}","[":"]"},u=e.reader_char,a=m(u);this.X_CONT={},this.X_BREK={},this.X_IMPORT={};var f="var __EXPORTS = {};",l="return (this === YAJET.X_IMPORT) ? __EXPORTS : __BUF;",c="var __BUF = '', VUT = OUT;function OUT(str) { if (str != null) __BUF += str };",h="return __BUF",p="} catch(ex) { if (ex === YAJET.X_CONT) continue;if (ex === YAJET.X_BREK) break;throw ex;}",E=YAJET.FILTERS={html:function(e){return String(e).replace(/&/g,"&amp;").replace(/\x22/g,"&quot;").replace(/\x27/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00A0/g,"&#xa0;")},upcase:function(e){return String(e).toUpperCase()},downcase:function(e){return String(e).toLowerCase()},plural:function(e,t){return t instanceof Array||(arguments.length>2?t=Array.$(arguments,1):t=t.split("|")),t=e<t.length?t[e]:t[t.length-1],t.replace(/##?/g,function(t){return t.length==2?"#":e})},trim:w};this.compile=v,this.filter=function(t){var n=x(arguments,1),r=e.filters[t]||E[t];if(r)return r.apply(this,n);y("No filter "+t)},this.process=function(e,n,r){r==null&&(r=[]);var i=t[e];return i||y("No exported function: "+e),i.apply(n,r)},this.reader_char=function(){return u}};